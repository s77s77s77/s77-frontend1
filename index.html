<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#000000">
<link rel="icon" type="image/png" href="./icon-192.png">

<title>SISTEMA S77 FULL</title>

<style>
body{
  font-family:impact;
  background-image: url("./bg.jpg");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-attachment: fixed;
  color:blue;
  text-align:center;
  padding:20px;
  }

h1{
  color: white;
  letter-spacing: 3px;
  text-shadow:
    0 0 6px #ffffff,
    0 0 12px #1e90ff,
    0 0 20px #1e90ff;
  animation: pulsoTitulo 3s ease-in-out infinite;
}
@keyframes pulsoTitulo{
  0%{
    text-shadow:
      0 0 6px #ffffff,
      0 0 12px #1e90ff,
      0 0 20px #1e90ff;
  }
  50%{
    text-shadow:
      0 0 10px #ffffff,
      0 0 20px #1e90ff,
      0 0 35px #1e90ff;
  }
  100%{
    text-shadow:
      0 0 6px #ffffff,
      0 0 12px #1e90ff,
      0 0 20px #1e90ff;
  }
}

/* OCULTAR TITULOS EXPLOSIVOS Y REPUESTO */
#explosivosTitle,
#repuestoTitle{
  display:none !important;
}

/* Capa oscura para mejorar lectura */
body::before{
  content:"";
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background: rgba(0,0,0,0.65);
  z-index:-1;
}
.hidden{display:none;}

.inputs{display:grid;gap:10px;justify-content:center;}
.inputs input{
  width:70px;
  height:70px;
  font-size:34px;
  font-weight:bold;

  background:#000000;        /* se pisa por JS según el número */
  border:3px solid #000000;  /* ✅ borde negro */

  color:#ffffff;             /* ✅ texto blanco SIEMPRE */
  text-align:center;
}

/* ✅ Layout ingreso */
.ingreso{
  display:grid;
  grid-template-columns: 1fr 1fr 1fr; /* ingreso | total | ganancia */
  gap:15px;
  justify-content:center;
  align-items:start;
  width: fit-content;
  margin: 0 auto;
}

.ingresoCol{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
}

.ingresoInput{
  width:80px;
  height:80px;
  font-size:36px;
  font-weight:bold;

  background-image: url("./bg-casino-green.png");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  border:none;
  border-radius:8px;

  color:#00ff88;
  text-align:center;

  text-shadow: 0 0 6px #00ff88;

  outline:none;
}

.label{margin-top:0;font-weight:bold;}

/* TOTAL */
.totalBox{
  width:120px;
  height:77px;
  font-size:34px;
  font-weight:bold;

  background-image: url("./btn-neon-cian.png");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  border:none;
  color:#ffffff;
  text-align:center;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:10px;

  text-shadow:
    0 1px 2px rgba(0,0,0,0.9),
    0 2px 4px rgba(0,0,0,0.8),
    0 0 6px rgba(0,0,0,0.6);
}
.totalLabel{margin-top:0;font-weight:bold;color:#0b8f3a;}

/* GANANCIA */
.gananciaBox{
  width:120px;
  height:77px;
  font-size:38px;
  font-weight:bold;

  background-image: url("./btn-neon-gold.png");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  border:none;
  color:#ffffff;
  text-align:center;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:10px;

  text-shadow:
    0 1px 2px rgba(0,0,0,0.95),
    0 2px 4px rgba(0,0,0,0.85),
    0 0 6px rgba(0,0,0,0.7);
}
.gananciaLabel{margin-top:0;font-weight:bold;color:#ffd400;}

/* ✅ ACIERTO debajo de GANANCIA */
.aciertoWrap{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
  margin-top:6px; /* separa de ganancia */
}
.aciertoBox{
  width:80px;
  height:80px;
  font-size:46px;
  font-weight:bold;

  background-image: url("./bg-acierto-blue.png");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  border:none;
  color:#ffffff;

  text-align:center;
  display:none;
  align-items:center;
  justify-content:center;

  border-radius:10px;

  text-shadow: 0 0 8px #00e5ff;
}
.aciertoLabel{margin-top:0;font-weight:bold;color:#0b57ff;display:none;}

.box{
  width:260px;min-height:60px;margin:10px auto;border:6px solid #444;
  font-weight:bold;padding:5px;
}

/* EXPLOSIVOS */
.explosivos{
  background: #0b1a2a;          /* azul noche sobrio */
  color: #ffffff;
  font-size: 48px;
  font-weight: bold;

  padding: 16px;
  border-radius: 8px;

  border: 3px solid #c9a24d;    /* dorado clásico */
  
  box-shadow:
    0 0 4px rgba(0,0,0,0.8),    /* sombra base */
    0 2px 6px rgba(0,0,0,0.9);  /* profundidad */

  text-shadow:
    0 1px 2px rgba(0,0,0,0.9);  /* lectura limpia */
}
.explosivos.warnRepeats{ background:red !important; }
.explosivos.warnTriples{ background:#0b57ff !important; } /* (no se usa si backend no manda blue) */

/* REPUESTO */
.repuesto{
  background: #2b0f14;          /* bordó oscuro */
  color: #ffffff;
  font-size: 48px;
  font-weight: bold;

  padding: 16px;
  border-radius: 8px;

  border: 3px solid #c9a24d;    /* mismo dorado para coherencia */

  box-shadow:
    0 0 4px rgba(0,0,0,0.8),
    0 2px 6px rgba(0,0,0,0.9);

  text-shadow:
    0 1px 2px rgba(0,0,0,0.9);
}
.repuestoTitle{color:#ff00ff;margin-top:10px;display:none;}

button{padding:10px;background:maroon;color:white;font-weight:bold;border:none;border-radius:8px;}

.abcWrap{display:flex;gap:10px;justify-content:center;margin-top:12px;flex-wrap:wrap;}
.abc{
  width:80px;
  height:80px;
  font-size:36px;
  font-weight:bold;

  background-image: url("./bg-casino-square.png");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  border:none;
  color:#FFD700;

  display:none;
  align-items:center;
  justify-content:center;

  border-radius:8px;

  text-shadow: 0 0 6px #FFD700;
}

/* LOGIN + ADMIN */
.loginBox{
  display:inline-block;
  padding:14px 16px;
  border:2px solid #444;
  border-radius:10px;
}
.loginRow{margin:8px 0;}
.loginInput{
  width:220px;height:36px;font-size:18px;padding:6px 10px;
  border:2px solid #444;background:#111;color:#fff;border-radius:8px;
}

.adminPanel{
  width:340px;margin:18px auto 0;border:2px solid #444;border-radius:10px;
  padding:12px;text-align:left;
}
.adminTitle{font-weight:bold;margin-bottom:10px;}
.adminGrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.adminGrid input{
  width:100%;height:34px;font-size:16px;padding:4px 8px;
  border:2px solid #444;background:#111;color:#fff;border-radius:8px;
}
.adminBtns{display:flex;gap:8px;margin-top:10px;}
.adminBtns button{flex:1;padding:10px 0;}
.adminOut{margin-top:10px;font-size:14px;color:#ddd;word-break:break-word;line-height:1.35;}
.smallNote{margin-top:6px;font-size:12px;color:#aaa;}

/* SALIR */
.logoutBtn{
  margin-top:14px;
  padding:8px 14px;
  background:#222;
  color:#fff;
  border:2px solid #444;
  border-radius:10px;
  font-weight:bold;
}
</style>
</head>

<body>

<h1>SISTEMA S77 FULL</h1>

<div id="login" class="loginBox">
  <div class="loginRow"><input id="usuario" class="loginInput" placeholder="Usuario"></div>
  <div class="loginRow"><input id="clave" class="loginInput" placeholder="Clave" type="password"></div>
  <div class="loginRow"><button onclick="ingresar()">INGRESAR</button></div>
  <p id="err" style="color:red;margin:6px 0 0;"></p>
</div>

<div id="sistema" class="hidden">

  <div class="inputs" id="casilleros"></div>

  <br>

  <!-- ✅ NUEVO LAYOUT -->
  <div class="ingreso">
    <div class="ingresoCol">
      <input id="nuevo" class="ingresoInput">
      <div class="label" style="color:#00ff88; text-shadow:0 0 6px #00ff88;">INGRESO</div>
    </div>

    <div class="ingresoCol">
      <div id="totalFichas" class="totalBox">0</div>
      <div class="totalLabel" style="color:#00e5ff; text-shadow:0 0 6px #00e5ff;">TOTAL</div>
    </div>

    <div class="ingresoCol">
      <div id="gananciaBox" class="gananciaBox">0</div>
      <div class="gananciaLabel" style="color:#ffd700; text-shadow:0 0 6px #ffd700;">GANANCIA</div>

      <div class="aciertoWrap">
        <div id="aciertoBox" class="aciertoBox">0</div>
        <div id="aciertoLabel" class="aciertoLabel" style="color:#00e5ff; text-shadow:0 0 6px #00e5ff;">ACIERTO</div>
      </div>
    </div>
  </div>

  <div style="margin-top:12px;">
    <button onclick="resetear()">REINICIAR</button>
  </div>

  <h3 id="explosivosTitle" style="color:black">EXPLOSIVOS</h3>
  <div id="explosivos" class="box explosivos">—</div>

  <h3 id="repuestoTitle" class="repuestoTitle">REPUESTO</h3>
  <div id="repuesto" class="box repuesto">—</div>

  <div class="abcWrap">
    <div id="A" class="abc"></div><div id="B" class="abc"></div><div id="C" class="abc"></div><div id="D" class="abc"></div><div id="E" class="abc"></div>
    <div id="F" class="abc"></div><div id="G" class="abc"></div><div id="H" class="abc"></div><div id="I" class="abc"></div><div id="J" class="abc"></div>
    <div id="K" class="abc"></div><div id="L" class="abc"></div><div id="M" class="abc"></div><div id="N" class="abc"></div><div id="O" class="abc"></div>
    <div id="P" class="abc"></div><div id="Q" class="abc"></div><div id="R" class="abc"></div><div id="S" class="abc"></div><div id="T" class="abc"></div>
  </div>

  <div id="adminPanel" class="adminPanel hidden">
    <div class="adminTitle">CREAR USUARIO (CON VENCIMIENTO)</div>

    <div class="adminGrid">
      <input id="newUser" placeholder="Usuario">
      <input id="newPass" placeholder="Clave">
    </div>

    <div class="adminBtns">
      <button onclick="crearUsuario(1)">1 DÍA</button>
      <button onclick="crearUsuario(7)">7 DÍAS</button>
      <button onclick="crearUsuario(30)">30 DÍAS</button>
    </div>

    <div id="adminOut" class="adminOut"></div>
    <div class="smallNote">Se guarda en el servidor (backend).</div>
  </div>

  <button class="logoutBtn" onclick="salir()">SALIR</button>
</div>

<script>
const API = "https://s77-backend1.onrender.com";

const TOKEN_KEY = "S77_TOKEN_V1";
const ROLE_KEY  = "S77_ROLE_V1";

let TOKEN = localStorage.getItem(TOKEN_KEY) || "";
let ROLE  = localStorage.getItem(ROLE_KEY) || "";

/* Service Worker */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js").catch(()=>{});
}

/* GANANCIA */
const GANANCIA_KEY = "S77_GANANCIA_V1";
let gananciaAcum = Number(localStorage.getItem(GANANCIA_KEY) || 0);
if (!Number.isFinite(gananciaAcum)) gananciaAcum = 0;

function setGanancia(v){
  const n = Number(v);
  gananciaAcum = Number.isFinite(n) ? n : 0;
  gananciaBox.textContent = String(Math.round(gananciaAcum));
  localStorage.setItem(GANANCIA_KEY, String(gananciaAcum));
}
setGanancia(gananciaAcum);

function renderAcierto(show, value){
  const box = document.getElementById("aciertoBox");
  const lab = document.getElementById("aciertoLabel");
  if(!box || !lab) return;

  if(show){
    box.style.display = "flex";
    lab.style.display = "block";
    box.textContent = String(Math.round(Number(value)||0));
  }else{
    box.style.display = "none";
    lab.style.display = "none";
    box.textContent = "0";
  }
}
function sumarGananciaDesdeAcierto(value){
  const n = Number(value);
  if(!Number.isFinite(n)) return;
  setGanancia(gananciaAcum + n);
}
function setTotalFichas(v){
  const n = Number(v);
  totalFichas.textContent = Number.isFinite(n) ? String(Math.round(n)) : "0";
}

/* WARN */
function getWarnModeFromData(data){
  if(data && typeof data.warnMode === "string") return data.warnMode;
  if(data && data.warnRepeats) return "red";
  return "none";
}

/* SUSPENSIÓN UI */
function aplicarSuspensionUI(active){
  const expTitle = document.getElementById("explosivosTitle");
  const repTitle = document.getElementById("repuestoTitle");
  const repBox   = document.getElementById("repuesto");

  if(active){
    if(expTitle) expTitle.style.display = "none";
    explosivos.style.display = "none";
    if(repTitle) repTitle.style.display = "none";
    if(repBox){ repBox.style.display = "none"; repBox.textContent = "—"; }
    renderAcierto(false, 0);
  }
}

/* ✅ CAMBIO: SOLO UN CASILLERO VISIBLE A LA VEZ */
function aplicarWarnMode(mode){
  const m = mode || "none";

  // clases de color en explosivos (por si las querés usar visualmente)
  explosivos.classList.remove("warnRepeats","warnTriples");
  if(m === "red") explosivos.classList.add("warnRepeats");
  if(m === "blue") explosivos.classList.add("warnTriples"); // (no se usa si backend no manda blue)

  const expBox = document.getElementById("explosivos");
  const repBox = document.getElementById("repuesto");

  if(!expBox || !repBox) return;

  if(m === "none"){
    // ✅ por defecto: solo EXPLOSIVOS
    expBox.style.display = "block";
    repBox.style.display = "none";
    repBox.textContent = "—";
  }else if(m === "red"){
    // ✅ con 2 repetidos: solo REPUESTO
    expBox.style.display = "none";
    repBox.style.display = "block";
  }else{
    // ✅ con 3 repetidos (azul): ninguno
    expBox.style.display = "none";
    repBox.style.display = "none";
    repBox.textContent = "—";
  }
}

/* ✅ CAMBIO: renderRepuesto respeta la regla (solo visible en ROJO) */
function renderRepuesto(arr, mode, suspensionActive){
  const box = document.getElementById("repuesto");
  if(!box) return;

  if(suspensionActive || mode === "blue" || mode === "none"){
    box.style.display = "none";
    box.textContent = "—";
    return;
  }

  const cleanArr = Array.isArray(arr) ? arr : [];
  const show = (mode === "red") && cleanArr.length;

  if(show){
    box.style.display = "block";
    box.textContent = cleanArr.join(" ");
  }else{
    box.style.display = "none";
    box.textContent = "—";
  }
}

/* =========================
   COLORES POR NÚMERO (ULTIMOS 16 / 5)
   ✅ Verde ajustado "ruleta"
========================= */
const NUM_BG = {
  0:"#0b7a3b",      // ✅ verde ruleta (más oscuro)
  1:"#ff0000",
  2:"#000000",
  3:"#ff0000",
  4:"#000000",
  5:"#ff0000",
  6:"#000000",
  7:"#ff0000",
  8:"#000000",
  9:"#ff0000",
  10:"#000000",
  11:"#000000",
  12:"#ff0000",
  13:"#000000",
  14:"#ff0000",
  15:"#000000",
  16:"#ff0000",
  17:"#000000",
  18:"#ff0000",
  19:"#ff0000",
  20:"#000000",
  21:"#ff0000",
  22:"#000000",
  23:"#ff0000",
  24:"#000000",
  25:"#ff0000",
  26:"#000000",
  27:"#ff0000",
  28:"#000000",
  29:"#000000",
  30:"#ff0000",
  31:"#000000",
  32:"#ff0000",
  33:"#000000",
  34:"#ff0000",
  35:"#000000",
  36:"#ff0000",
};

function pintarCasilleroPorNumero(inputEl){
  const v = parseInt(inputEl.value, 10);
  inputEl.style.background = Number.isFinite(v) ? (NUM_BG[v] || "#000") : "#000";
  inputEl.style.color = "#fff";       // texto blanco SIEMPRE
  inputEl.style.borderColor = "#000"; // borde negro
}

/* =========================
   Validación
========================= */
function validarNumero(n){
  if(!Number.isInteger(n)) return { ok:false, msg:"Tenés que ingresar un número entero." };
  if(n < 0 || n > 36) return { ok:false, msg:"Solo se permiten números del 0 al 36." };
  return { ok:true, msg:"" };
}

/* PAUSA A..T */
let conteoPausado = false;
let cacheActiveId = "A";
let cacheActiveMult = 1;
let cacheInicializado = false;

function ocultarAT(){
  const ids = ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T"];
  ids.forEach(id=>{
    const el=document.getElementById(id);
    if(!el) return;
    el.style.display="none";
    el.textContent="";
  });
}
function mostrarAT(id, mult){
  ocultarAT();
  const elActive = document.getElementById(id);
  if (elActive) {
    elActive.style.display = "flex";
    elActive.textContent = String(mult);
  }
}
function aplicarConteoDesdeBackend(activeId, activeMult){
  if(!cacheInicializado){
    cacheInicializado = true;
    cacheActiveId = activeId || "A";
    cacheActiveMult = Number(activeMult) || 1;
    mostrarAT(cacheActiveId, cacheActiveMult);
    return;
  }
  if(conteoPausado){
    mostrarAT(cacheActiveId, cacheActiveMult);
    return;
  }
  cacheActiveId = activeId || cacheActiveId;
  cacheActiveMult = Number(activeMult) || cacheActiveMult;
  mostrarAT(cacheActiveId, cacheActiveMult);
}
function syncPausaConteoConColor(){
  conteoPausado =
    explosivos.classList.contains("warnRepeats") ||
    explosivos.classList.contains("warnTriples");
}

/* ADMIN */
async function crearUsuario(dias){
  if(ROLE !== "admin"){
    adminOut.innerHTML = "Solo admin puede crear usuarios.";
    return;
  }
  const u=(newUser.value||"").trim();
  const p=(newPass.value||"").trim();
  if(!u || !p){
    adminOut.innerHTML = "Falta <b>Usuario</b> y/o <b>Clave</b>.";
    return;
  }
  try{
    const r = await fetch(`${API}/admin/create-user`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization": `Bearer ${TOKEN}`
      },
      body: JSON.stringify({ user:u, pass:p, days:dias })
    });

    const data = await r.json();
    if(!r.ok){
      adminOut.innerHTML = "Error creando usuario (¿token inválido o no sos admin?)";
      return;
    }
    const expDate = new Date(data.exp).toLocaleString();
    adminOut.innerHTML =
      `✅ Creado/actualizado:<br>`+
      `<b>Usuario:</b> ${data.user}<br>`+
      `<b>Clave:</b> ${p}<br>`+
      `<b>Vence:</b> ${expDate} (${dias} día${dias===1?"":"s"})`;
  }catch(e){
    adminOut.innerHTML = "No conecta con el servidor. ¿Está prendido el backend?";
  }
}

/* Mostrar/ocultar login */
function mostrarLogin(){
  login.classList.remove("hidden");
  login.style.display = "inline-block";
  sistema.classList.add("hidden");
  sistema.style.display = "none";
}
function mostrarSistema(){
  login.classList.add("hidden");
  login.style.display = "none";
  sistema.classList.remove("hidden");
  sistema.style.display = "block";
  if(ROLE === "admin") adminPanel.classList.remove("hidden");
  else adminPanel.classList.add("hidden");
}

/* LOGIN */
async function ingresar(){
  const u=(usuario.value||"").trim();
  const p=(clave.value||"").trim();
  if(!u || !p){ err.innerText="Completa usuario y clave"; return; }

  try{
    const r = await fetch(`${API}/auth/login`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ user:u, pass:p })
    });

    const data = await r.json();
    if(!r.ok){
      err.innerText="Usuario/clave inválidos o vencidos";
      return;
    }

    TOKEN = data.token;
    ROLE = data.role;

    localStorage.setItem(TOKEN_KEY, TOKEN);
    localStorage.setItem(ROLE_KEY, ROLE);

    err.innerText="";
    mostrarSistema();
    await cargarEstado();
  }catch(e){
    err.innerText="No conecta con el servidor. ¿Está prendido el backend?";
  }
}

/* SALIR */
function salir(){
  if(!confirm("¿Seguro querés salir?")) return;
  TOKEN = "";
  ROLE = "";
  localStorage.removeItem(TOKEN_KEY);
  localStorage.removeItem(ROLE_KEY);
  mostrarLogin();
}

/* Render inicial */
function renderInicial(){
  casilleros.innerHTML="";
  casilleros.style.gridTemplateColumns="repeat(4,70px)";
  for(let i=0;i<16;i++){
    let c=document.createElement("input");
    c.disabled=true;
    c.value = "";
    pintarCasilleroPorNumero(c); // ✅
    casilleros.appendChild(c);
  }
}

async function cargarEstado(){
  try{
    const r = await fetch(`${API}/api/state`,{
      method:"GET",
      headers:{ "Authorization": `Bearer ${TOKEN}` }
    });

    const data = await r.json();
    if(!r.ok){ salir(); return; }

    casilleros.innerHTML="";

    if(data.historialLen < 17){
      casilleros.style.gridTemplateColumns="repeat(4,70px)";
      data.ultimos16.forEach(v=>{
        const c=document.createElement("input");
        c.disabled=true;
        c.value=v;

        pintarCasilleroPorNumero(c); // ✅

        casilleros.appendChild(c);
      });
      if(data.historialLen===0) renderInicial();
    }else{
      casilleros.style.gridTemplateColumns="repeat(5,70px)";
      data.ultimos5.forEach(v=>{
        const c=document.createElement("input");
        c.disabled=true;
        c.value=v;

        pintarCasilleroPorNumero(c); // ✅

        casilleros.appendChild(c);
      });
    }

    const suspensionActive = !!data.suspensionActive;

    explosivos.innerText = (data.explosivos && data.explosivos.length)
      ? data.explosivos.join(" ")
      : "—";

    const mode = getWarnModeFromData(data);

    if(suspensionActive){
      aplicarSuspensionUI(true);
    }else{
      aplicarWarnMode(mode);
    }

    syncPausaConteoConColor();
    renderRepuesto(data.repuesto, mode, suspensionActive);

    setTotalFichas(data.fichasTotal);
    aplicarConteoDesdeBackend(data.activeId, data.activeMult);
    renderAcierto(false, 0);

  }catch(e){}
}

async function resetear(){
  if(!TOKEN){ alert("Tenés que estar logueado."); return; }
  if(!confirm("¿Seguro querés reiniciar tu historial?")) return;

  try{
    const r = await fetch(`${API}/api/reset`,{
      method:"POST",
      headers:{ "Authorization": `Bearer ${TOKEN}` }
    });

    if(!r.ok){ alert("No se pudo reiniciar."); return; }

    aplicarWarnMode("none");
    syncPausaConteoConColor();
    setTotalFichas(0);
    renderRepuesto([], "none", false);
    renderAcierto(false, 0);
    setGanancia(0);

    await cargarEstado();
  }catch(e){
    alert("No conecta con el backend.");
  }
}

/* ENTER */
nuevo.addEventListener("keydown", async (e) => {
  if (e.key !== "Enter") return;

  if(!TOKEN){
    alert("Primero tenés que ingresar con usuario y clave.");
    return;
  }

  const n = parseInt(nuevo.value, 10);
  const v = validarNumero(n);
  if(!v.ok){ alert(v.msg); return; }

  nuevo.value = "";

  try {
    const r = await fetch(`${API}/api/enter`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${TOKEN}`
      },
      body: JSON.stringify({ n })
    });

    const data = await r.json();
    if (!r.ok) { salir(); return; }

    casilleros.innerHTML = "";

    if (data.historialLen < 17) {
      casilleros.style.gridTemplateColumns = "repeat(4,70px)";
      data.ultimos16.forEach(v => {
        const c = document.createElement("input");
        c.disabled = true;
        c.value = v;

        pintarCasilleroPorNumero(c); // ✅

        casilleros.appendChild(c);
      });
      if(data.historialLen === 0) renderInicial();
    } else {
      casilleros.style.gridTemplateColumns = "repeat(5,70px)";
      data.ultimos5.forEach(v => {
        const c = document.createElement("input");
        c.disabled = true;
        c.value = v;

        pintarCasilleroPorNumero(c); // ✅

        casilleros.appendChild(c);
      });
    }

    const suspensionActive = !!data.suspensionActive;

    explosivos.innerText = (data.explosivos && data.explosivos.length)
      ? data.explosivos.join(" ")
      : "—";

    const mode = getWarnModeFromData(data);

    if(suspensionActive){
      aplicarSuspensionUI(true);
    }else{
      aplicarWarnMode(mode);
    }

    syncPausaConteoConColor();
    renderRepuesto(data.repuesto, mode, suspensionActive);

    setTotalFichas(data.fichasTotal);
    aplicarConteoDesdeBackend(data.activeId, data.activeMult);

    if(suspensionActive){
      renderAcierto(false, 0);
      return;
    }

    const show = !!data.aciertoShow;
    const val  = Number(data.aciertoValue);

    renderAcierto(show, val);
    if(show){ sumarGananciaDesdeAcierto(val); }

  } catch (err) {
    alert("No conecta con el backend. ¿Está prendido?");
  }
});

/* Auto-login */
(async function init(){
  if(TOKEN){
    mostrarSistema();
    await cargarEstado();
  }else{
    mostrarLogin();
  }
})();
</script>

</body>
</html>





