<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#000000">
<link rel="icon" type="image/png" href="./icon-192.png">

<title>SISTEMA S77 FULL</title>

<style>
body{
  font-family:impact;
  background:black;
  color:blue;
  text-align:center;
  padding:20px;
}
.hidden{display:none;}

.inputs{
  display:grid;
  gap:10px;
  justify-content:center;
}
.inputs input{
  width:70px;
  height:70px;
  font-size:34px;
  font-weight:bold;
  border:4px solid #444;
  background:#333;
  color:white;
  text-align:center;
}

.ingreso{
  display:flex;
  justify-content:center;
  gap:15px;
  align-items:flex-start;
}

.ingresoInput{
  width:70px;
  height:70px;
  font-size:34px;
  border:4px solid #1e90ff;
  background:#1e90ff;
  color:#ccc;
  text-align:center;
}

.label{
  margin-top:5px;
  font-weight:bold;
}

/* TOTAL */
.totalBox{
  width:120px;
  height:70px;
  font-size:34px;
  font-weight:bold;
  border:4px solid #0b8f3a;
  background:#0b8f3a;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:8px;
}
.totalLabel{color:#0b8f3a;font-weight:bold;}

/* ACIERTO */
.aciertoBox{
  width:120px;
  height:70px;
  font-size:54px;
  font-weight:bold;
  border:4px solid #0b57ff;
  background:#0b57ff;
  color:#ffd700;
  display:none;
  align-items:center;
  justify-content:center;
  border-radius:8px;
}
.aciertoLabel{
  color:#0b57ff;
  font-weight:bold;
  display:none;
}

/* GANANCIA */
.gananciaBox{
  width:120px;
  height:70px;
  font-size:38px;
  font-weight:bold;
  border:4px solid #ffd400;
  background:#ffd400;
  color:#0b57ff;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:8px;
}
.gananciaLabel{color:#ffd400;font-weight:bold;}

.aciertoGananciaCol{
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* BOXES */
.box{
  width:260px;
  min-height:60px;
  margin:10px auto;
  border:6px solid #444;
  font-weight:bold;
  padding:5px;
}
.explosivos{background:black;font-size:48px;}
.explosivos.warnRepeats{background:red!important;}

.repuesto{
  background:#ff00ff;
  color:white;
  font-size:48px;
  display:none;
}

/* BOTONES */
button{
  padding:10px;
  background:maroon;
  color:white;
  font-weight:bold;
  border:none;
  border-radius:8px;
}

/* A..T */
.abcWrap{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
}
.abc{
  width:70px;
  height:70px;
  font-size:34px;
  border:4px solid white;
  background:#0b57ff;
  color:white;
  display:none;
  align-items:center;
  justify-content:center;
}

/* LOGIN */
.loginBox{
  border:2px solid #444;
  border-radius:10px;
  padding:16px;
  display:inline-block;
}
.loginInput{
  width:220px;
  height:36px;
  font-size:18px;
  background:#111;
  color:white;
  border:2px solid #444;
  border-radius:8px;
  padding:5px;
  margin:5px;
}
</style>
</head>

<body>

<h1>SISTEMA S77 FULL</h1>

<div id="login" class="loginBox">
  <input id="usuario" class="loginInput" placeholder="Usuario"><br>
  <input id="clave" class="loginInput" placeholder="Clave"><br>
  <button onclick="ingresar()">INGRESAR</button>
  <p id="err" style="color:red"></p>
</div>

<div id="sistema" class="hidden">

<div class="inputs" id="casilleros"></div>

<br>

<div class="ingreso">
  <div>
    <input id="nuevo" class="ingresoInput">
    <div class="label" style="color:#1e90ff">INGRESO</div>
  </div>

  <div>
    <div id="totalFichas" class="totalBox">0</div>
    <div class="totalLabel">TOTAL</div>
  </div>

  <div class="aciertoGananciaCol">
    <div>
      <div id="aciertoBox" class="aciertoBox">0</div>
      <div id="aciertoLabel" class="aciertoLabel">ACIERTO</div>
    </div>

    <div>
      <div id="gananciaBox" class="gananciaBox">0</div>
      <div class="gananciaLabel">GANANCIA</div>
    </div>
  </div>
</div>

<br>
<button onclick="resetear()">REINICIAR</button>

<h3 style="color:black">EXPLOSIVOS</h3>
<div id="explosivos" class="box explosivos">â€”</div>

<!-- ðŸ”¥ CASILLERO FUCSIA SIN TEXTO -->
<div id="repuesto" class="box repuesto">â€”</div>

<div class="abcWrap">
  <div id="A" class="abc"></div><div id="B" class="abc"></div><div id="C" class="abc"></div>
  <div id="D" class="abc"></div><div id="E" class="abc"></div><div id="F" class="abc"></div>
  <div id="G" class="abc"></div><div id="H" class="abc"></div><div id="I" class="abc"></div>
  <div id="J" class="abc"></div><div id="K" class="abc"></div><div id="L" class="abc"></div>
  <div id="M" class="abc"></div><div id="N" class="abc"></div><div id="O" class="abc"></div>
  <div id="P" class="abc"></div><div id="Q" class="abc"></div><div id="R" class="abc"></div>
  <div id="S" class="abc"></div><div id="T" class="abc"></div>
</div>

</div>

<script>
const API="https://s77-backend1.onrender.com";
let TOKEN="";

/* GANANCIA */
let ganancia=Number(localStorage.getItem("S77_GANANCIA")||0);
gananciaBox.textContent=ganancia;

function setGanancia(v){
  ganancia=v;
  gananciaBox.textContent=v;
  localStorage.setItem("S77_GANANCIA",v);
}

function renderAcierto(show,val){
  if(show){
    aciertoBox.style.display="flex";
    aciertoLabel.style.display="block";
    aciertoBox.textContent=val;
    setGanancia(ganancia+val);
  }else{
    aciertoBox.style.display="none";
    aciertoLabel.style.display="none";
  }
}

/* LOGIN */
async function ingresar(){
  const u=usuario.value;
  const p=clave.value;

  const r=await fetch(API+"/auth/login",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({user:u,pass:p})
  });

  const data=await r.json();
  if(!r.ok){
    err.textContent="Error login";
    return;
  }

  TOKEN=data.token;
  login.classList.add("hidden");
  sistema.classList.remove("hidden");
  cargarEstado();
}

/* STATE */
async function cargarEstado(){
  const r=await fetch(API+"/api/state",{headers:{Authorization:"Bearer "+TOKEN}});
  const data=await r.json();

  totalFichas.textContent=data.fichasTotal;
  explosivos.textContent=data.explosivos.join(" ")||"â€”";

  if(data.warnRepeats) explosivos.classList.add("warnRepeats");
  else explosivos.classList.remove("warnRepeats");

  if(data.warnRepeats && data.repuesto.length){
    repuesto.style.display="block";
    repuesto.textContent=data.repuesto.join(" ");
  }else{
    repuesto.style.display="none";
  }

  renderAcierto(false,0);
}

/* RESET */
async function resetear(){
  await fetch(API+"/api/reset",{method:"POST",headers:{Authorization:"Bearer "+TOKEN}});
  setGanancia(0);
  renderAcierto(false,0);
  cargarEstado();
}

/* ENTER */
nuevo.addEventListener("keydown",async e=>{
  if(e.key!=="Enter") return;

  const n=parseInt(nuevo.value);
  nuevo.value="";

  const r=await fetch(API+"/api/enter",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+TOKEN
    },
    body:JSON.stringify({n})
  });

  const data=await r.json();

  totalFichas.textContent=data.fichasTotal;
  explosivos.textContent=data.explosivos.join(" ")||"â€”";

  if(data.warnRepeats) explosivos.classList.add("warnRepeats");
  else explosivos.classList.remove("warnRepeats");

  if(data.warnRepeats && data.repuesto.length){
    repuesto.style.display="block";
    repuesto.textContent=data.repuesto.join(" ");
  }else{
    repuesto.style.display="none";
  }

  renderAcierto(data.aciertoShow,data.aciertoValue);
});
</script>

</body>
</html>
